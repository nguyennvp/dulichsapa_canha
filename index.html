<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Family Travel Planner</title>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabaseUrl = "https://uqexdrrmmmjtvtntavtb.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxZXhkcnJtbW1qdHZ0bnRhdnRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NDkyOTMsImV4cCI6MjA3OTUyNTI5M30.69ZiV6JZVbS0fWVcILLAcklSLgXieehfet_Y2T2WYzY";
    const supabase = createClient(supabaseUrl, supabaseKey);

    async function saveTrip() {
      const trip = {
        trip_name: document.getElementById("trip_name").value,
        date_from: document.getElementById("date_from").value,
        date_to: document.getElementById("date_to").value,
        hotel_cost_per_day: document.getElementById("hotel_cost").value,
        food_cost_per_day: document.getElementById("food_cost").value,
      };

      const { data: tripData, error: tripErr } = await supabase
        .from("trips").insert(trip).select();
      if (tripErr) return alert("Lỗi lưu trip: " + tripErr.message);

      const tripId = tripData[0].id;

      const familiesText = document.getElementById("families").value.split(";");
      const families = familiesText.map(f => {
        const p = f.split(":");
        return { trip_id: tripId, family_name: p[0], total_people: Number(p[1]) };
      });

      await supabase.from("families").insert(families);

      const transportText = document.getElementById("transport").value.split(";");
      const transport = transportText.map(t => {
        const p = t.split(",");
        return {
          trip_id: tripId,
          from_location: p[0],
          to_location: p[1],
          cost: Number(p[2])
        };
      });

      await supabase.from("transport").insert(transport);

      alert("Đã lưu đầy đủ thông tin chuyến đi!");
    }

    async function loadTrips() {
      const { data, error } = await supabase.from("trips").select();
      if (error) return;
      const list = document.getElementById("trip_list");
      list.innerHTML = "";
      data.forEach(t => {
        const item = document.createElement("div");
        item.innerHTML = `<b>${t.trip_name}</b> — ${t.date_from} → ${t.date_to}`;
        list.appendChild(item);
      });
    }

    window.onload = loadTrips;
  </script>
  <style>
    body { font-family: Arial; padding: 20px; max-width: 700px; margin: auto; }
    input, textarea { width: 100%; padding: 8px; margin: 6px 0; }
    button { padding: 10px 20px; margin-top: 12px; }
    .section { margin-top: 25px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
  </style>
</head>
<body>
  <h1>Quản lý chuyến du lịch gia đình</h1>

  <div class="section">
    <h2>Thông tin chuyến đi</h2>
    <label>Tên chuyến đi:</label>
    <input type="text" id="trip_name" />

    <label>Ngày đi:</label>
    <input type="date" id="date_from" />

    <label>Ngày về:</label>
    <input type="date" id="date_to" />

    <label>Tiền khách sạn / ngày:</label>
    <input type="number" id="hotel_cost" />

    <label>Tiền ăn mỗi ngày:</label>
    <input type="number" id="food_cost" />
  </div>

  <div class="section">
    <h2>Danh sách gia đình</h2>
    <p>Nhập theo dạng: "Bố mẹ:2; Anh A:4; Anh B:3"</p>
    <textarea id="families" rows="4"></textarea>
  </div>

  <div class="section">
    <h2>Chi phí di chuyển</h2>
    <p>Nhập theo dạng: "HCM,Đà Lạt,2000000; Đà Lạt,Chợ đêm,100000"</p>
    <textarea id="transport" rows="4"></textarea>
  </div>

  <button onclick="saveTrip()">Lưu toàn bộ dữ liệu</button>

  <div class="section">
    <h2>Danh sách chuyến đi đã lưu</h2>
    <div id="trip_list"></div>
  </div>

</body>
</html>
