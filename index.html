<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·∫£ Nh√† M√¨nh ƒêi Du L·ªãch Sa Pa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .family-header {
            background-image: url('https://uqexdrrmmmjtvtntavtb.supabase.co/storage/v1/object/public/ANH%20GIA%20DINH/z7256591072776_cf067dabfb0c5479d1012ef80c5f32c3.jpg');
            background-size: 50%;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
        }
        .family-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.3);
        }
        .family-header-content {
            position: relative;
            z-index: 1;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <!-- Header v·ªõi background ·∫£nh gia ƒë√¨nh -->
    <div class="family-header h-64 md:h-80 flex items-center justify-center">
        <div class="family-header-content text-center text-white px-4">
            <h1 class="text-5xl md:text-6xl font-bold mb-4 drop-shadow-lg">
                üèîÔ∏è C·∫£ Nh√† M√¨nh ƒêi Du L·ªãch Sa Pa üèîÔ∏è
            </h1>
            <p class="text-xl md:text-2xl drop-shadow-md">Web n√†y t·∫°o ra nh·∫±m l∆∞u gi·ªØ kho·∫£nh kh·∫Øc gia ƒë√¨nh</p>
            <p class="text-sm mt-2 opacity-90"></p>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 -mt-16">
        <!-- Main Card -->
        <div class="bg-white rounded-lg shadow-2xl p-6 mb-6">
            <p class="text-center text-gray-600 mb-4">K·∫ø ho·∫°ch chi ti·∫øt</p>

            <!-- Ph·∫ßn 1: Th√¥ng tin chung -->
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-indigo-500 pb-2">
                    üìÖ Th√¥ng tin chung
                </h2>
                
                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Ng√†y th√°ng -->
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Ng√†y b·∫Øt ƒë·∫ßu
                            </label>
                            <input type="date" id="startDate" onchange="updateDays()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                Ng√†y k·∫øt th√∫c
                            </label>
                            <input type="date" id="endDate" onchange="updateDays()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <p class="text-lg font-semibold text-indigo-700">
                                T·ªïng s·ªë ng√†y: <span id="totalDays" class="text-2xl">0</span> ng√†y
                            </p>
                            <p class="text-sm text-gray-600 mt-1">
                                (<span id="totalNights">0</span> ƒë√™m)
                            </p>
                        </div>
                    </div>

                    <!-- S·ªë ng∆∞·ªùi -->
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üë• Ng∆∞·ªùi l·ªõn
                                </label>
                                <input type="number" id="adults" value="2" min="0" onchange="updateCosts()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    üë∂ Tr·∫ª em
                                </label>
                                <input type="number" id="children" value="0" min="0" onchange="updateCosts()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                üè® Chi ph√≠ kh√°ch s·∫°n/ng√†y (VNƒê)
                            </label>
                            <input type="number" id="hotelCostPerDay" value="0" onchange="updateCosts()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                            <p class="text-sm text-gray-600 mt-1">
                                T·ªïng: <span id="totalHotelCost">0 ‚Ç´</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Chi ph√≠ di chuy·ªÉn -->
                <div class="mt-6 grid md:grid-cols-2 gap-6">
                    <!-- V√© m√°y bay -->
                    <div class="bg-blue-50 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-blue-700 mb-3">‚úàÔ∏è V√© m√°y bay</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Ng∆∞·ªùi l·ªõn (VNƒê)
                                </label>
                                <input type="number" id="flightAdult" value="0" onchange="updateCosts()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Tr·∫ª em (VNƒê)
                                </label>
                                <input type="number" id="flightChild" value="0" onchange="updateCosts()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="mt-3 bg-blue-100 p-2 rounded">
                            <p class="text-sm font-semibold text-blue-800">
                                T·ªïng v√© m√°y bay: <span id="totalFlight">0 ‚Ç´</span>
                            </p>
                        </div>
                    </div>

                    <!-- V√© xe gi∆∞·ªùng n·∫±m -->
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-green-700 mb-3">üöå Xe gi∆∞·ªùng n·∫±m (N·ªôi B√†i - Sa Pa)</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Ng∆∞·ªùi l·ªõn (VNƒê)
                                </label>
                                <input type="number" id="busAdult" value="0" onchange="updateCosts()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Tr·∫ª em (VNƒê)
                                </label>
                                <input type="number" id="busChild" value="0" onchange="updateCosts()" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500">
                            </div>
                        </div>
                        <div class="mt-3 bg-green-100 p-2 rounded">
                            <p class="text-sm font-semibold text-green-800">
                                T·ªïng v√© xe: <span id="totalBus">0 ‚Ç´</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- T·ªïng chi ph√≠ -->
                <div class="mt-6 bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-2">üí∞ T·ªïng chi ph√≠ d·ª± ki·∫øn</h3>
                    <p class="text-3xl font-bold" id="grandTotal">0 ‚Ç´</p>
                    <div class="mt-3 text-sm opacity-90 space-y-1">
                        <p>‚Ä¢ Kh√°ch s·∫°n: <span id="summaryHotel">0 ‚Ç´</span></p>
                        <p>‚Ä¢ V√© m√°y bay: <span id="summaryFlight">0 ‚Ç´</span></p>
                        <p>‚Ä¢ Xe gi∆∞·ªùng n·∫±m: <span id="summaryBus">0 ‚Ç´</span></p>
                        <p class="text-xs mt-2 opacity-75">(Ch∆∞a bao g·ªìm chi ph√≠ ho·∫°t ƒë·ªông h√†ng ng√†y)</p>
                    </div>
                </div>
            </div>

            <!-- Ph·∫ßn 2: Chi ti·∫øt k·∫ø ho·∫°ch -->
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b-2 border-indigo-500 pb-2">
                    üìù Chi ti·∫øt k·∫ø ho·∫°ch theo ng√†y
                </h2>

                <div id="dailyPlans">
                    <p class="text-gray-500 text-center py-8">
                        Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c ƒë·ªÉ xem k·∫ø ho·∫°ch chi ti·∫øt
                    </p>
                </div>
            </div>

            <!-- N√∫t l∆∞u ·ªü d∆∞·ªõi c√πng -->
            <div class="flex justify-center pt-6 border-t-2 border-gray-200">
                <button onclick="saveTrip()" id="saveBtn" class="flex items-center gap-2 bg-green-500 text-white px-8 py-3 rounded-lg hover:bg-green-600 transition shadow-lg text-lg font-semibold">
                    <span>üíæ</span> L∆∞u k·∫ø ho·∫°ch
                </button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://uqexdrrmmmjtvtntavtb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxZXhkcnJtbW1qdHZ0bnRhdnRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NDkyOTMsImV4cCI6MjA3OTUyNTI5M30.69ZiV6JZVbS0fWVcILLAcklSLgXieehfet_Y2T2WYzY';

        let dailyActivities = {};
        let loadedTripId = null;

        // Load data when page loads
        window.onload = function() {
            loadTrip();
        };

        async function loadTrip() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/trips?order=created_at.desc&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const trip = data[0];
                        loadedTripId = trip.id;
                        
                        // Load general info
                        document.getElementById('startDate').value = trip.general_info.startDate || '';
                        document.getElementById('endDate').value = trip.general_info.endDate || '';
                        document.getElementById('adults').value = trip.general_info.adults || 2;
                        document.getElementById('children').value = trip.general_info.children || 0;
                        document.getElementById('hotelCostPerDay').value = trip.general_info.hotelCostPerDay || 0;
                        document.getElementById('flightAdult').value = trip.general_info.flightAdult || 0;
                        document.getElementById('flightChild').value = trip.general_info.flightChild || 0;
                        document.getElementById('busAdult').value = trip.general_info.busAdult || 0;
                        document.getElementById('busChild').value = trip.general_info.busChild || 0;
                        
                        // Load daily plans
                        dailyActivities = trip.daily_plans || {};
                        
                        updateDays();
                        updateCosts();
                    }
                }
            } catch (error) {
                console.error('Error loading trip:', error);
            }
        }

        async function saveTrip() {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.innerHTML = '<span>‚è≥</span> ƒêang l∆∞u...';
            saveBtn.disabled = true;

            const generalInfo = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                adults: parseInt(document.getElementById('adults').value) || 0,
                children: parseInt(document.getElementById('children').value) || 0,
                hotelCostPerDay: parseFloat(document.getElementById('hotelCostPerDay').value) || 0,
                flightAdult: parseFloat(document.getElementById('flightAdult').value) || 0,
                flightChild: parseFloat(document.getElementById('flightChild').value) || 0,
                busAdult: parseFloat(document.getElementById('busAdult').value) || 0,
                busChild: parseFloat(document.getElementById('busChild').value) || 0
            };

            const tripData = {
                general_info: generalInfo,
                daily_plans: dailyActivities,
                updated_at: new Date().toISOString()
            };

            try {
                let response;
                if (loadedTripId) {
                    // Update existing trip
                    response = await fetch(`${SUPABASE_URL}/rest/v1/trips?id=eq.${loadedTripId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(tripData)
                    });
                } else {
                    // Create new trip
                    response = await fetch(`${SUPABASE_URL}/rest/v1/trips`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            ...tripData,
                            created_at: new Date().toISOString()
                        })
                    });
                }

                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        loadedTripId = data[0].id;
                    }
                    alert('‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!');
                } else {
                    alert('‚ùå L·ªói khi l∆∞u. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            } catch (error) {
                console.error('Error saving trip:', error);
                alert('‚ùå L·ªói khi l∆∞u. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.');
            }

            saveBtn.innerHTML = '<span>üíæ</span> L∆∞u k·∫ø ho·∫°ch';
            saveBtn.disabled = false;
        }

        function calculateDays() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) return 0;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            return diff > 0 ? diff : 0;
        }

        function updateDays() {
            const days = calculateDays();
            const nights = days > 0 ? days - 1 : 0;
            
            document.getElementById('totalDays').textContent = days;
            document.getElementById('totalNights').textContent = nights;
            
            updateCosts();
            renderDailyPlans();
        }

        function updateCosts() {
            const days = calculateDays();
            const nights = days > 0 ? days - 1 : 0;
            const hotelCostPerDay = parseFloat(document.getElementById('hotelCostPerDay').value) || 0;
            const adults = parseInt(document.getElementById('adults').value) || 0;
            const children = parseInt(document.getElementById('children').value) || 0;
            const flightAdult = parseFloat(document.getElementById('flightAdult').value) || 0;
            const flightChild = parseFloat(document.getElementById('flightChild').value) || 0;
            const busAdult = parseFloat(document.getElementById('busAdult').value) || 0;
            const busChild = parseFloat(document.getElementById('busChild').value) || 0;
            
            const totalHotelCost = nights * hotelCostPerDay;
            const totalFlightCost = (adults * flightAdult) + (children * flightChild);
            const totalBusCost = (adults * busAdult) + (children * busChild);
            const grandTotal = totalHotelCost + totalFlightCost + totalBusCost;
            
            document.getElementById('totalHotelCost').textContent = formatCurrency(totalHotelCost);
            document.getElementById('totalFlight').textContent = formatCurrency(totalFlightCost);
            document.getElementById('totalBus').textContent = formatCurrency(totalBusCost);
            document.getElementById('grandTotal').textContent = formatCurrency(grandTotal);
            document.getElementById('summaryHotel').textContent = formatCurrency(totalHotelCost);
            document.getElementById('summaryFlight').textContent = formatCurrency(totalFlightCost);
            document.getElementById('summaryBus').textContent = formatCurrency(totalBusCost);
        }

        function renderDailyPlans() {
            const days = calculateDays();
            const container = document.getElementById('dailyPlans');
            
            if (days === 0) {
                container.innerHTML = `
                    <p class="text-gray-500 text-center py-8">
                        Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c ƒë·ªÉ xem k·∫ø ho·∫°ch chi ti·∫øt
                    </p>
                `;
                return;
            }
            
            let html = '<div class="space-y-6">';
            
            for (let day = 1; day <= days; day++) {
                html += `
                    <div class="border-2 border-indigo-200 rounded-lg p-4 bg-gradient-to-r from-indigo-50 to-purple-50">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-indigo-600">üìç Ng√†y ${day}</h3>
                            <button onclick="addActivity(${day})" class="flex items-center gap-2 bg-indigo-500 text-white px-3 py-2 rounded-lg hover:bg-indigo-600 transition">
                                <span>‚ûï</span> Th√™m ho·∫°t ƒë·ªông
                            </button>
                        </div>
                        <div id="day-${day}-activities" class="space-y-3">
                `;
                
                if (dailyActivities[day]) {
                    dailyActivities[day].forEach((activity, index) => {
                        html += renderActivity(day, index, activity);
                    });
                }
                
                html += `
                        </div>
                        <div class="mt-4 bg-indigo-100 p-3 rounded-lg border-l-4 border-indigo-500">
                            <p class="text-lg font-semibold text-indigo-700">
                                üíµ T·ªïng chi ph√≠ ng√†y ${day}: <span id="day-${day}-total">${formatCurrency(calculateDayTotal(day))}</span>
                            </p>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function renderActivity(day, index, activity) {
            return `
                <div class="grid grid-cols-12 gap-2 bg-white p-3 rounded-lg shadow-sm">
                    <input type="time" value="${activity.time || ''}" onchange="updateActivity(${day}, ${index}, 'time', this.value)" class="col-span-2 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500" placeholder="Th·ªùi gian">
                    <input type="text" value="${activity.info || ''}" onchange="updateActivity(${day}, ${index}, 'info', this.value)" class="col-span-4 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500" placeholder="Th√¥ng tin ho·∫°t ƒë·ªông">
                    <input type="text" value="${activity.note || ''}" onchange="updateActivity(${day}, ${index}, 'note', this.value)" class="col-span-3 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500" placeholder="Ghi ch√∫">
                    <input type="number" value="${activity.cost || 0}" onchange="updateActivity(${day}, ${index}, 'cost', this.value)" class="col-span-2 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500" placeholder="Gi√° ti·ªÅn">
                    <button onclick="deleteActivity(${day}, ${index})" class="col-span-1 bg-red-500 text-white rounded hover:bg-red-600 transition flex items-center justify-center">
                        üóëÔ∏è
                    </button>
                </div>
            `;
        }

        function addActivity(day) {
            if (!dailyActivities[day]) {
                dailyActivities[day] = [];
            }
            dailyActivities[day].push({
                time: '',
                info: '',
                note: '',
                cost: 0
            });
            renderDailyPlans();
        }

        function updateActivity(day, index, field, value) {
            if (dailyActivities[day] && dailyActivities[day][index]) {
                dailyActivities[day][index][field] = field === 'cost' ? parseFloat(value) || 0 : value;
                document.getElementById(`day-${day}-total`).textContent = formatCurrency(calculateDayTotal(day));
            }
        }

        function deleteActivity(day, index) {
            if (dailyActivities[day]) {
                dailyActivities[day].splice(index, 1);
                renderDailyPlans();
            }
        }

        function calculateDayTotal(day) {
            if (!dailyActivities[day]) return 0;
            return dailyActivities[day].reduce((sum, activity) => sum + (parseFloat(activity.cost) || 0), 0);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
    </script>
</body>
</html>


