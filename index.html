<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Quản lý Chuyến Đi Gia Đình</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f1f5f9; }
    .loading { opacity: 0.7; pointer-events: none; }
  </style>
</head>
<body class="min-h-screen bg-gray-100">
  <div class="container mx-auto p-4 max-w-7xl">

    <h1 class="text-4xl font-bold text-center my-8 text-indigo-700">
      <i class="fas fa-suitcase-rolling mr-3"></i>
      Quản Lý Chuyến Đi Gia Đình
    </h1>

    <!-- Danh sách chuyến đi -->
    <div id="trips-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <!-- Các card chuyến đi sẽ được render bằng JS -->
    </div>

    <!-- Chi tiết chuyến đi (modal) -->
    <div id="trip-detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50 p-4">
      <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-screen overflow-y-auto">
        <div class="p-6 border-b flex justify-between items-center">
          <h2 id="modal-title" class="text-2xl font-bold text-indigo-700"></h2>
          <button onclick="closeModal()" class="text-gray-500 hover:text-gray-800 text-2xl">
            &times;
          </button>
        </div>

        <div class="p-6" id="modal-content">
          <!-- Nội dung chi tiết sẽ được render ở đây -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // ======== THAY ĐỔI 2 DÒNG NÀY BẰNG PROJECT CỦA BẠN ========
    const SUPABASE_URL = 'https://uqexdrrmmmjtvtntavtb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxZXhkcnJtbW1qdHZ0bnRhdnRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NDkyOTMsImV4cCI6MjA3OTUyNTI5M30.69ZiV6JZVbS0fWVcILLAcklSLgXieehfet_Y2T2WYzY';
    // =========================================================

    const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Load danh sách chuyến đi khi mở trang
    window.onload = () => loadTrips();

    async function loadTrips() {
      const { data: trips, error } = await supabase
        .from('trips')
        .select('*')
        .order('date_from', { ascending: false });

      if (error) {
        alert('Lỗi tải dữ liệu: ' + error.message);
        return;
      }

      const container = document.getElementById('trips-list');
      container.innerHTML = '';

      if (trips.length === 0) {
        container.innerHTML = '<p class="text-center col-span-full text-gray-500 text-xl">Chưa có chuyến đi nào</p>';
        return;
      }

      trips.forEach(trip => {
        const days = trip.date_to ? 
          Math.ceil((new Date(trip.date_to) - new Date(trip.date_from)) / 86400000) + 1 : 1;

        const card = `
          <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer p-6"
               onclick="openTripDetail(${trip.id})">
            <h3 class="text-xl font-bold text-indigo-700 mb-2">${trip.trip_name || 'Chưa đặt tên'}</h3>
            <div class="text-sm text-gray-600 space-y-1">
              <p><i class="fas fa-calendar mr-2"></i>
                ${formatDate(trip.date_from)} → ${trip.date_to ? formatDate(trip.date_to) : '...'} 
                <span class="font-medium">(${days} ngày)</span>
              </p>
              <p><i class="fas fa-users mr-2"></i>${trip.total_families} gia đình – ${trip.total_people} người</p>
              <p><i class="fas fa-hotel mr-2"></i>Khách sạn: ${formatMoney(trip.hotel_cost_per_day)} / ngày</p>
              <p><i class="fas fa-utensils mr-2"></i>Ăn uống: ${formatMoney(trip.food_cost_per_day)} / ngày</p>
              <p><i class="fas fa-bus mr-2"></i>Di chuyển tổng: ${formatMoney(trip.transport_total)}</p>
            </div>
            <div class="mt-4 text-right">
              <span class="text-xs text-gray-400">
                Tạo lúc ${new Date(trip.created_at).toLocaleString('vi-VN')}
              </span>
            </div>
          </div>
        `;
        container.innerHTML += card;
      });
    }

    async function openTripDetail(tripId) {
      document.getElementById('trip-detail-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      const { data: trip } = await supabase.from('trips').select('*').eq('id', tripId).single();
      
      document.getElementById('modal-title').textContent = trip.trip_name || 'Chuyến đi #' + trip.id;

      // Lấy dữ liệu liên quan
      const [families, transports, dailyFoods] = await Promise.all([
        supabase.from('families').select('*').eq('trip_id', tripId),
        supabase.from('transport').select('*').eq('trip_id', tripId),
        supabase.from('daily_food_cost').select('*').eq('trip_id', tripId).order('date')
      ]);

      const days = trip.date_to ? 
        Math.ceil((new Date(trip.date_to) - new Date(trip.date_from)) / 86400000) + 1 : 1;

      let totalHotel = (trip.hotel_cost_per_day || 0) * days;
      let totalFood = (trip.food_cost_per_day || 0) * days;
      let totalTransport = trip.transport_total || 0;

      let html = `
        <div class="grid md:grid-cols-2 gap-6 mb-8">
          <div>
            <h4 class="font-bold text-lg mb-3"><i class="fas fa-info-circle mr-2"></i>Thông tin chung</h4>
            <table class="w-full text-sm">
              <tr><td class="py-1 font-medium">Thời gian</td><td>: ${formatDate(trip.date_from)} → ${trip.date_to ? formatDate(trip.date_to) : 'Chưa xác định'} (${days} ngày)</td></tr>
              <tr><td class="py-1 font-medium">Số gia đình</td><td>: ${trip.total_families}</td></tr>
              <tr><td class="py-1 font-medium">Tổng người</td><td>: ${trip.total_people}</td></tr>
              <tr><td class="py-1 font-medium">Khách sạn/ngày</td><td>: ${formatMoney(trip.hotel_cost_per_day)}</td></tr>
              <tr><td class="py-1 font-medium">Ăn uống/ngày</td><td>: ${formatMoney(trip.food_cost_per_day)}</td></tr>
              <tr><td class="py-1 font-medium">Di chuyển tổng</td><td>: ${formatMoney(trip.transport_total)}</td></tr>
            </table>
          </div>
          <div class="text-right">
            <div class="bg-indigo-50 p-5 rounded-lg">
              <p class="text-sm text-gray-600">Tổng chi phí ước tính</p>
              <p class="text-3xl font-bold text-indigo-700">${formatMoney(totalHotel + totalFood + totalTransport)}</p>
              <p class="text-xs text-gray-500 mt-2">
                Khách sạn ${formatMoney(totalHotel)} + Ăn uống ${formatMoney(totalFood)} + Di chuyển ${formatMoney(totalTransport)}
              </p>
            </div>
          </div>
        </div>

        <!-- Danh sách gia đình -->
        <div class="mt-8">
          <h4 class="font-bold text-lg mb-3"><i class="fas fa-users mr-2 text-green-600"></i>Danh sách gia đình (${families.data.length})</h4>
          ${families.data.length === 0 ? '<p class="text-gray-500">Chưa có gia đình nào</p>' : 
            '<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">' +
            families.data.map(f => `
              <div class="bg-green-50 p-3 rounded-lg text-center">
                <p class="font-medium">${f.family_name}</p>
                <p class="text-sm text-gray-600">${f.total_people} người</p>
              </div>
            `).join('') + '</div>'
          }
        </div>

        <!-- Di chuyển -->
        <div class="mt-8">
          <h4 class="font-bold text-lg mb-3"><i class="fas fa-bus mr-2 text-blue-600"></i>Chi phí di chuyển</h4>
          ${transports.data.length === 0 ? '<p class="text-gray-500">Chưa có dữ liệu di chuyển</p>' :
            '<div class="overflow-x-auto"><table class="w-full text-sm border-collapse">
              <thead class="bg-blue-100"><tr>
                <th class="p-2 text-left">Từ → Đến</th>
                <th class="p-2">Loại</th>
                <th class="p-2 text-right">Chi phí</th>
              </tr></thead>
              <tbody>' +
              transports.data.map(t => `
                <tr class="border-b">
                  <td class="p-2">${t.from_location} → ${t.to_location}</td>
                  <td class="p-2 text-center">${t.type || '-'}</td>
                  <td class="p-2 text-right font-medium">${formatMoney(t.cost)}</td>
                </tr>
              `).join('') + 
              `<tr class="font-bold bg-blue-50">
                <td colspan="2" class="p-3 text-right">Tổng cộng</td>
                <td class="p-3 text-right">${formatMoney(trip.transport_total)}</td>
              </tr>
              </tbody></table></div>`
          }
        </div>

        <!-- Chi phí ăn uống từng ngày -->
        <div class="mt-8">
          <h4 class="font-bold text-lg mb-3"><i class="fas fa-utensils mr-2 text-orange-600"></i>Chi phí ăn uống theo ngày</h4>
          ${dailyFoods.data.length === 0 ? '<p class="text-gray-500">Chưa có dữ liệu chi tiết ăn uống</p>' :
            '<div class="overflow-x-auto"><table class="w-full text-sm border-collapse">
              <thead class="bg-orange-100"><tr>
                <th class="p-2">Ngày</th>
                <th class="p-2 text-right">Sáng</th>
                <th class="p-2 text-right">Trưa</th>
                <th class="p-2 text-right">Tối</th>
                <th class="p-2 text-right font-bold">Tổng</th>
              </tr></thead>
              <tbody>' +
              dailyFoods.data.map(d => `
                <tr class="border-b">
                  <td class="p-2 font-medium">${formatDate(d.date)}</td>
                  <td class="p-2 text-right">${formatMoney(d.breakfast)}</td>
                  <td class="p-2 text-right">${formatMoney(d.lunch)}</td>
                  <td class="p-2 text-right">${formatMoney(d.dinner)}</td>
                  <td class="p-2 text-right font-bold">${formatMoney(d.total)}</td>
                </tr>
              `).join('') +
              '</tbody></table></div>'
          }
        </div>
      `;

      document.getElementById('modal-content').innerHTML = html;
    }

    function closeModal() {
      document.getElementById('trip-detail-modal').classList.add('hidden');
      document.body.style.overflow = 'auto';
    }

    // Helper functions
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      return new Date(dateStr).toLocaleDateString('vi-VN');
    }

    function formatMoney(num) {
      if (num === null || num === undefined) return '0 ₫';
      return Number(num).toLocaleString('vi-VN') + ' ₫';
    }

    // Đóng modal khi click ngoài
    document.getElementById('trip-detail-modal').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
  </script>
</body>
</html>
