<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C·∫£ Nh√† M√¨nh ƒêi Du L·ªãch Sa Pa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-4xl font-bold text-indigo-600 text-center mb-2">
                üèîÔ∏è C·∫£ Nh√† M√¨nh ƒêi Du L·ªãch Sa Pa üèîÔ∏è
            </h1>
            <p class="text-center text-gray-600">K·∫ø ho·∫°ch chi ti·∫øt cho chuy·∫øn ƒëi gia ƒë√¨nh</p>
            <div class="flex justify-end mt-4">
                <button onclick="saveTrip()" id="saveBtn" class="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">
                    <span>üíæ</span> L∆∞u k·∫ø ho·∫°ch
                </button>
            </div>
        </div>

        <!-- Ph·∫ßn 1: Th√¥ng tin chung -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                üìÖ Ph·∫ßn 1: Th√¥ng tin chung
            </h2>
            
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Ng√†y th√°ng -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ng√†y b·∫Øt ƒë·∫ßu
                        </label>
                        <input type="date" id="startDate" onchange="updateDays()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Ng√†y k·∫øt th√∫c
                        </label>
                        <input type="date" id="endDate" onchange="updateDays()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <p class="text-lg font-semibold text-indigo-700">
                            T·ªïng s·ªë ng√†y: <span id="totalDays" class="text-2xl">0</span> ng√†y
                        </p>
                        <p class="text-sm text-gray-600 mt-1">
                            (<span id="totalNights">0</span> ƒë√™m)
                        </p>
                    </div>
                </div>

                <!-- S·ªë ng∆∞·ªùi v√† chi ph√≠ -->
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                üë• Ng∆∞·ªùi l·ªõn
                            </label>
                            <input type="number" id="adults" value="2" min="0" onchange="updateCosts()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                üë∂ Tr·∫ª em
                            </label>
                            <input type="number" id="children" value="0" min="0" onchange="updateCosts()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Chi ph√≠ kh√°ch s·∫°n/ng√†y (VNƒê)
                        </label>
                        <input type="number" id="hotelCostPerDay" value="0" onchange="updateCosts()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <p class="text-sm text-gray-600 mt-1">
                            T·ªïng: <span id="totalHotelCost">0 ‚Ç´</span>
                        </p>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                V√© ng∆∞·ªùi l·ªõn (VNƒê)
                            </label>
                            <input type="number" id="adultTicket" value="0" onchange="updateCosts()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                V√© tr·∫ª em (VNƒê)
                            </label>
                            <input type="number" id="childTicket" value="0" onchange="updateCosts()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg">
                        <p class="text-lg font-semibold text-green-700">
                            T·ªïng v√© di chuy·ªÉn: <span id="totalTicketCost">0 ‚Ç´</span>
                        </p>
                    </div>
                </div>
            </div>

            <!-- T·ªïng chi ph√≠ -->
            <div class="mt-6 bg-gradient-to-r from-indigo-500 to-purple-500 text-white p-6 rounded-lg">
                <h3 class="text-xl font-bold mb-2">T·ªïng chi ph√≠ d·ª± ki·∫øn</h3>
                <p class="text-3xl font-bold" id="grandTotal">0 ‚Ç´</p>
                <p class="text-sm mt-2 opacity-90">
                    (Ch∆∞a bao g·ªìm chi ph√≠ ho·∫°t ƒë·ªông h√†ng ng√†y)
                </p>
            </div>
        </div>

        <!-- Ph·∫ßn 2: Chi ti·∫øt k·∫ø ho·∫°ch -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                üí∞ Ph·∫ßn 2: Chi ti·∫øt k·∫ø ho·∫°ch theo ng√†y
            </h2>

            <div id="dailyPlans">
                <p class="text-gray-500 text-center py-8">
                    Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c ƒë·ªÉ xem k·∫ø ho·∫°ch chi ti·∫øt
                </p>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://uqexdrrmmmjtvtntavtb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxZXhkcnJtbW1qdHZ0bnRhdnRiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM5NDkyOTMsImV4cCI6MjA3OTUyNTI5M30.69ZiV6JZVbS0fWVcILLAcklSLgXieehfet_Y2T2WYzY';

        let dailyActivities = {};
        let loadedTripId = null;

        // Load data when page loads
        window.onload = function() {
            loadTrip();
        };

        async function loadTrip() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/trips?order=created_at.desc&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const trip = data[0];
                        loadedTripId = trip.id;
                        
                        // Load general info
                        document.getElementById('startDate').value = trip.general_info.startDate || '';
                        document.getElementById('endDate').value = trip.general_info.endDate || '';
                        document.getElementById('adults').value = trip.general_info.adults || 2;
                        document.getElementById('children').value = trip.general_info.children || 0;
                        document.getElementById('hotelCostPerDay').value = trip.general_info.hotelCostPerDay || 0;
                        document.getElementById('adultTicket').value = trip.general_info.adultTicketCost || 0;
                        document.getElementById('childTicket').value = trip.general_info.childTicketCost || 0;
                        
                        // Load daily plans
                        dailyActivities = trip.daily_plans || {};
                        
                        updateDays();
                        updateCosts();
                    }
                }
            } catch (error) {
                console.error('Error loading trip:', error);
            }
        }

        async function saveTrip() {
            const saveBtn = document.getElementById('saveBtn');
            saveBtn.innerHTML = '<span>‚è≥</span> ƒêang l∆∞u...';
            saveBtn.disabled = true;

            const generalInfo = {
                startDate: document.getElementById('startDate').value,
                endDate: document.getElementById('endDate').value,
                adults: parseInt(document.getElementById('adults').value) || 0,
                children: parseInt(document.getElementById('children').value) || 0,
                hotelCostPerDay: parseFloat(document.getElementById('hotelCostPerDay').value) || 0,
                adultTicketCost: parseFloat(document.getElementById('adultTicket').value) || 0,
                childTicketCost: parseFloat(document.getElementById('childTicket').value) || 0
            };

            const tripData = {
                general_info: generalInfo,
                daily_plans: dailyActivities,
                updated_at: new Date().toISOString()
            };

            try {
                let response;
                if (loadedTripId) {
                    // Update existing trip
                    response = await fetch(`${SUPABASE_URL}/rest/v1/trips?id=eq.${loadedTripId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(tripData)
                    });
                } else {
                    // Create new trip
                    response = await fetch(`${SUPABASE_URL}/rest/v1/trips`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            ...tripData,
                            created_at: new Date().toISOString()
                        })
                    });
                }

                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        loadedTripId = data[0].id;
                    }
                    alert('‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng!');
                } else {
                    alert('‚ùå L·ªói khi l∆∞u. Vui l√≤ng th·ª≠ l·∫°i.');
                }
            } catch (error) {
                console.error('Error saving trip:', error);
                alert('‚ùå L·ªói khi l∆∞u. Vui l√≤ng ki·ªÉm tra k·∫øt n·ªëi.');
            }

            saveBtn.innerHTML = '<span>üíæ</span> L∆∞u k·∫ø ho·∫°ch';
            saveBtn.disabled = false;
        }

        function calculateDays() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            
            if (!startDate || !endDate) return 0;
            
            const start = new Date(startDate);
            const end = new Date(endDate);
            const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            return diff > 0 ? diff : 0;
        }

        function updateDays() {
            const days = calculateDays();
            const nights = days > 0 ? days - 1 : 0;
            
            document.getElementById('totalDays').textContent = days;
            document.getElementById('totalNights').textContent = nights;
            
            updateCosts();
            renderDailyPlans();
        }

        function updateCosts() {
            const days = calculateDays();
            const nights = days > 0 ? days - 1 : 0;
            const hotelCostPerDay = parseFloat(document.getElementById('hotelCostPerDay').value) || 0;
            const adults = parseInt(document.getElementById('adults').value) || 0;
            const children = parseInt(document.getElementById('children').value) || 0;
            const adultTicket = parseFloat(document.getElementById('adultTicket').value) || 0;
            const childTicket = parseFloat(document.getElementById('childTicket').value) || 0;
            
            const totalHotelCost = nights * hotelCostPerDay;
            const totalTicketCost = (adults * adultTicket) + (children * childTicket);
            const grandTotal = totalHotelCost + totalTicketCost;
            
            document.getElementById('totalHotelCost').textContent = formatCurrency(totalHotelCost);
            document.getElementById('totalTicketCost').textContent = formatCurrency(totalTicketCost);
            document.getElementById('grandTotal').textContent = formatCurrency(grandTotal);
        }

        function renderDailyPlans() {
            const days = calculateDays();
            const container = document.getElementById('dailyPlans');
            
            if (days === 0) {
                container.innerHTML = `
                    <p class="text-gray-500 text-center py-8">
                        Vui l√≤ng ch·ªçn ng√†y b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c ƒë·ªÉ xem k·∫ø ho·∫°ch chi ti·∫øt
                    </p>
                `;
                return;
            }
            
            let html = '<div class="space-y-6">';
            
            for (let day = 1; day <= days; day++) {
                html += `
                    <div class="border-2 border-indigo-200 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold text-indigo-600">Ng√†y ${day}</h3>
                            <button onclick="addActivity(${day})" class="flex items-center gap-2 bg-indigo-500 text-white px-3 py-2 rounded-lg hover:bg-indigo-600 transition">
                                <span>‚ûï</span> Th√™m ho·∫°t ƒë·ªông
                            </button>
                        </div>
                        <div id="day-${day}-activities" class="space-y-3">
                `;
                
                if (dailyActivities[day]) {
                    dailyActivities[day].forEach((activity, index) => {
                        html += renderActivity(day, index, activity);
                    });
                }
                
                html += `
                        </div>
                        <div class="mt-4 bg-indigo-50 p-3 rounded-lg">
                            <p class="text-lg font-semibold text-indigo-700">
                                T·ªïng chi ph√≠ ng√†y ${day}: <span id="day-${day}-total">${formatCurrency(calculateDayTotal(day))}</span>
                            </p>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            container.innerHTML = html;
        }

        function renderActivity(day, index, activity) {
            return `
                <div class="grid grid-cols-12 gap-2 bg-gray-50 p-3 rounded-lg">
                    <input type="time" value="${activity.time || ''}" onchange="updateActivity(${day}, ${index}, 'time', this.value)" class="col-span-2 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500" placeholder="Th·ªùi gian">
                    <input type="text" value="${activity.info || ''}" onchange="updateActivity(${day}, ${index}, 'info', this.value)" class="col-span-4 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500" placeholder="Th√¥ng tin ho·∫°t ƒë·ªông">
                    <input type="text" value="${activity.note || ''}" onchange="updateActivity(${day}, ${index}, 'note', this.value)" class="col-span-3 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500" placeholder="Ghi ch√∫">
                    <input type="number" value="${activity.cost || 0}" onchange="updateActivity(${day}, ${index}, 'cost', this.value)" class="col-span-2 px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-indigo-500" placeholder="Gi√° ti·ªÅn">
                    <button onclick="deleteActivity(${day}, ${index})" class="col-span-1 bg-red-500 text-white rounded hover:bg-red-600 transition flex items-center justify-center">
                        üóëÔ∏è
                    </button>
                </div>
            `;
        }

        function addActivity(day) {
            if (!dailyActivities[day]) {
                dailyActivities[day] = [];
            }
            dailyActivities[day].push({
                time: '',
                info: '',
                note: '',
                cost: 0
            });
            renderDailyPlans();
        }

        function updateActivity(day, index, field, value) {
            if (dailyActivities[day] && dailyActivities[day][index]) {
                dailyActivities[day][index][field] = field === 'cost' ? parseFloat(value) || 0 : value;
                document.getElementById(`day-${day}-total`).textContent = formatCurrency(calculateDayTotal(day));
            }
        }

        function deleteActivity(day, index) {
            if (dailyActivities[day]) {
                dailyActivities[day].splice(index, 1);
                renderDailyPlans();
            }
        }

        function calculateDayTotal(day) {
            if (!dailyActivities[day]) return 0;
            return dailyActivities[day].reduce((sum, activity) => sum + (parseFloat(activity.cost) || 0), 0);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
    </script>
</body>
</html>
